@page
@model CalorieTracker.Pages.DailyLogModel
@{
    ViewData["Title"] = "Daily Nutrition Tracker";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="bi bi-graph-up text-primary"></i> Daily Nutrition Tracker</h2>
                <div>
                    <form method="get" class="d-inline-flex gap-2">
                        <input type="date" 
                               name="selectedDate" 
                               value="@Model.SelectedDate.ToString("yyyy-MM-dd")" 
                               class="form-control"
                               onchange="this.form.submit()" />
                    </form>
                </div>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(Model.Message))
    {
        <div class="alert @(Model.IsSuccess ? "alert-success" : "alert-warning") alert-dismissible fade show">
            @Model.Message
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2">Calories</h6>
                    <h2 class="mb-1 @(Model.TotalCalories > Model.CurrentUser.DailyCalorieGoal ? "text-danger" : "text-primary")">
                        @Model.TotalCalories
                    </h2>
                    <small class="text-muted">/ @Model.CurrentUser.DailyCalorieGoal kcal</small>
                    <div class="progress mt-2" style="height: 5px;">
                        @{
                            var caloriePercent = Model.CurrentUser.DailyCalorieGoal > 0 
                                ? (double)Model.TotalCalories / Model.CurrentUser.DailyCalorieGoal * 100 
                                : 0;
                            var calorieClass = caloriePercent > 100 ? "bg-danger" : "bg-primary";
                        }
                        <div class="progress-bar @calorieClass" 
                             role="progressbar" 
                             style="width: @Math.Min(caloriePercent, 100)%">
                        </div>
                    </div>
                    @if (Model.RemainingCalories > 0)
                    {
                        <small class="text-success mt-1 d-block">@Model.RemainingCalories kcal remaining</small>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2"><i class="bi bi-egg-fried"></i> Protein</h6>
                    <h2 class="mb-1 text-success">@Model.TotalProtein.ToString("F1")g</h2>
                    <small class="text-muted">/ @Model.CurrentUser.MaxProtein g</small>
                    <div class="progress mt-2" style="height: 5px;">
                        @{
                            var proteinPercent = Model.CurrentUser.MaxProtein > 0 
                                ? (double)Model.TotalProtein / Model.CurrentUser.MaxProtein * 100 
                                : 0;
                        }
                        <div class="progress-bar bg-success" 
                             role="progressbar" 
                             style="width: @Math.Min(proteinPercent, 100)%">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2"><i class="bi bi-droplet"></i> Fat</h6>
                    <h2 class="mb-1 text-warning">@Model.TotalFat.ToString("F1")g</h2>
                    <small class="text-muted">/ @Model.CurrentUser.MaxFat g</small>
                    <div class="progress mt-2" style="height: 5px;">
                        @{
                            var fatPercent = Model.CurrentUser.MaxFat > 0 
                                ? (double)Model.TotalFat / Model.CurrentUser.MaxFat * 100 
                                : 0;
                        }
                        <div class="progress-bar bg-warning" 
                             role="progressbar" 
                             style="width: @Math.Min(fatPercent, 100)%">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-md-3 col-sm-6 mb-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h6 class="text-muted mb-2"><i class="bi bi-lightning"></i> Carbs</h6>
                    <h2 class="mb-1 text-info">@Model.TotalCarb.ToString("F1")g</h2>
                    <small class="text-muted">/ @Model.CurrentUser.MaxCarb g</small>
                    <div class="progress mt-2" style="height: 5px;">
                        @{
                            var carbPercent = Model.CurrentUser.MaxCarb > 0 
                                ? (double)Model.TotalCarb / Model.CurrentUser.MaxCarb * 100 
                                : 0;
                        }
                        <div class="progress-bar bg-info" 
                             role="progressbar" 
                             style="width: @Math.Min(carbPercent, 100)%">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Recommendations -->
    @if (Model.RemainingCalories > 0)
    {
        <div class="card shadow-sm mb-4 border-primary">
            <div class="card-header bg-gradient text-white">
                <h5 class="mb-0"><i class="bi bi-stars"></i> AI Food Recommendations</h5>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    You have <strong>@Model.RemainingCalories kcal</strong> remaining. Get personalized food suggestions!
                </p>
                
                <div class="d-flex gap-2 flex-wrap mb-3">
                    <form method="post" asp-page-handler="GetRecommendation" class="d-inline">
                        <input type="hidden" name="category" value="sweet" />
                        <input type="hidden" name="selectedDate" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                        <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-heart-fill"></i> Sweet Treats
                        </button>
                    </form>
                    <form method="post" asp-page-handler="GetRecommendation" class="d-inline">
                        <input type="hidden" name="category" value="delicious" />
                        <input type="hidden" name="selectedDate" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                        <button type="submit" class="btn btn-outline-warning">
                            <i class="bi bi-emoji-smile"></i> Delicious Meals
                        </button>
                    </form>
                    <form method="post" asp-page-handler="GetRecommendation" class="d-inline">
                        <input type="hidden" name="category" value="healthy" />
                        <input type="hidden" name="selectedDate" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                        <button type="submit" class="btn btn-outline-success">
                            <i class="bi bi-heart-pulse"></i> Healthy Options
                        </button>
                    </form>
                </div>

                @if (!string.IsNullOrEmpty(Model.AiRecommendation))
                {
                    <div class="alert alert-info">
                        <h6 class="alert-heading"><i class="bi bi-lightbulb"></i> AI Suggestions:</h6>
                        <pre class="mb-0" style="white-space: pre-wrap; font-family: inherit;">@Model.AiRecommendation</pre>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Search Food -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-search"></i> Search Food Database</h5>
        </div>
        <div class="card-body">
            <form method="post" asp-page-handler="SearchFood">
                <input type="hidden" name="selectedDate" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                <div class="row g-3">
                    <div class="col-md-10">
                        <label class="form-label">Search for food</label>
                        <input asp-for="SearchQuery" 
                               type="text" 
                               class="form-control form-control-lg" 
                               placeholder="e.g., chicken breast, apple, rice..." 
                               required />
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100 btn-lg">
                            <i class="bi bi-search"></i> Search
                        </button>
                    </div>
                </div>
            </form>

            @if (Model.SearchResults != null && Model.SearchResults.Any())
            {
                <div class="mt-4">
                    <h6 class="mb-3"><i class="bi bi-list"></i> Search Results (@Model.SearchResults.Count results)</h6>
                    <div class="list-group">
                        @foreach (var food in Model.SearchResults)
                        {
                            var calories = food.FoodNutrients?.FirstOrDefault(n => n.NutrientName.Contains("Energy"))?.Value ?? 0;
                            var protein = food.FoodNutrients?.FirstOrDefault(n => n.NutrientName.Contains("Protein"))?.Value ?? 0;
                            var fat = food.FoodNutrients?.FirstOrDefault(n => n.NutrientName.Contains("Total lipid"))?.Value ?? 0;
                            var carb = food.FoodNutrients?.FirstOrDefault(n => n.NutrientName.Contains("Carbohydrate"))?.Value ?? 0;

                            <div class="list-group-item">
                                <div class="row align-items-center">
                                    <div class="col-md-5">
                                        <strong>@food.Description</strong>
                                        @if (!string.IsNullOrEmpty(food.BrandOwner))
                                        {
                                            <br/><small class="text-muted">@food.BrandOwner</small>
                                        }
                                        @if (food.DataType == "Branded")
                                        {
                                            <span class="badge bg-info ms-2">Brand</span>
                                        }
                                    </div>
                                    <div class="col-md-4">
                                        <small>
                                            <i class="bi bi-fire text-danger"></i> @calories.ToString("F0") kcal | 
                                            <i class="bi bi-egg-fried text-success"></i> P: @protein.ToString("F1")g | 
                                            <i class="bi bi-droplet text-warning"></i> F: @fat.ToString("F1")g | 
                                            <i class="bi bi-lightning text-info"></i> C: @carb.ToString("F1")g
                                        </small>
                                    </div>
                                    <div class="col-md-3">
                                        <form method="post" asp-page-handler="AddFood" class="d-flex gap-2">
                                            <input type="hidden" name="selectedDate" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                                            <input type="hidden" name="selectedFdcId" value="@food.FdcId" />
                                            <input type="number" 
                                                   name="grams" 
                                                   value="100" 
                                                   min="1" 
                                                   max="2000" 
                                                   step="1"
                                                   class="form-control form-control-sm" 
                                                   style="width: 80px;" 
                                                   placeholder="Grams" />
                                            <button type="submit" class="btn btn-success btn-sm">
                                                <i class="bi bi-plus-circle"></i> Add
                                            </button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            }
        </div>
    </div>

    <!-- Today's Logs -->
    <div class="card shadow-sm">
        <div class="card-header bg-secondary text-white">
            <h5 class="mb-0"><i class="bi bi-journal-check"></i> Consumed Foods - @Model.SelectedDate.ToString("MMMM dd, yyyy")</h5>
        </div>
        <div class="card-body">
            @if (Model.TodayLogs.Any())
            {
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Food</th>
                                <th class="text-center">Amount</th>
                                <th class="text-end">Calories</th>
                                <th class="text-end">Protein</th>
                                <th class="text-end">Fat</th>
                                <th class="text-end">Carbs</th>
                                <th class="text-center">Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var log in Model.TodayLogs)
                            {
                                var multiplier = log.Grams / 100m;
                                <tr>
                                    <td>@log.ConsumedAt.ToString("HH:mm")</td>
                                    <td>
                                        <strong>@log.FoodItem.Name</strong>
                                        @if (!string.IsNullOrEmpty(log.FoodItem.BrandName))
                                        {
                                            <br/><small class="text-muted">@log.FoodItem.BrandName</small>
                                        }
                                    </td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">@log.Grams g</span>
                                    </td>
                                    <td class="text-end">@((log.FoodItem.Calories * multiplier).ToString("F0")) kcal</td>
                                    <td class="text-end">@(((decimal)log.FoodItem.Protein * multiplier).ToString("F1"))g</td>
                                    <td class="text-end">@(((decimal)log.FoodItem.Fat * multiplier).ToString("F1"))g</td>
                                    <td class="text-end">@(((decimal)log.FoodItem.Carb * multiplier).ToString("F1"))g</td>
                                    <td class="text-center">
                                        <form method="post" asp-page-handler="DeleteLog" class="d-inline">
                                            <input type="hidden" name="logId" value="@log.Id" />
                                            <input type="hidden" name="selectedDate" value="@Model.SelectedDate.ToString("yyyy-MM-dd")" />
                                            <button type="submit" 
                                                    class="btn btn-sm btn-outline-danger"
                                                    onclick="return confirm('Are you sure you want to delete this entry?')">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>
                        <tfoot class="table-light">
                            <tr class="fw-bold">
                                <td colspan="3" class="text-end">TOTAL:</td>
                                <td class="text-end">@Model.TotalCalories.ToString("F0") kcal</td>
                                <td class="text-end">@Model.TotalProtein.ToString("F1")g</td>
                                <td class="text-end">@Model.TotalFat.ToString("F1")g</td>
                                <td class="text-end">@Model.TotalCarb.ToString("F1")g</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center py-5">
                    <i class="bi bi-inbox" style="font-size: 4rem; opacity: 0.3;"></i>
                    <p class="text-muted mt-3">You haven't added any foods for today yet.</p>
                    <p class="text-muted">Use the search form above to find and add foods.</p>
                </div>
            }
        </div>
    </div>

    <!-- Quick Navigation -->
    <div class="mt-4 text-center">
        <a asp-page="/SearchFood" class="btn btn-outline-success">
            <i class="bi bi-search"></i> Advanced Food Search
        </a>
    </div>
</div>

<style>
    .bg-gradient {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    /* Smooth animations for cards */
    .card {
        transition: all 0.3s ease;
    }
    
    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3) !important;
    }
    
    /* Pulse animation for remaining calories */
    @@keyframes pulse {
        0%, 100% {
            transform: scale(1);
        }
        50% {
            transform: scale(1.05);
        }
    }
    
    .text-success.d-block {
        animation: pulse 2s infinite;
    }
    
    /* Progress bar animation */
    .progress-bar {
        transition: width 0.6s ease;
    }
    
    /* Button hover effects */
    .btn {
        transition: all 0.3s ease;
    }
    
    .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    /* List item hover */
    .list-group-item {
        transition: all 0.2s ease;
    }
    
    .list-group-item:hover {
        transform: translateX(5px);
    }
    
    /* Table row hover */
    .table tbody tr {
        transition: background-color 0.2s ease;
    }
    
    /* Smooth scroll behavior */
    html {
        scroll-behavior: smooth;
    }
    
    /* Loading spinner for forms */
    .btn.loading {
        position: relative;
        pointer-events: none;
    }
    
    .btn.loading:after {
        content: "";
        position: absolute;
        width: 16px;
        height: 16px;
        top: 50%;
        left: 50%;
        margin-left: -8px;
        margin-top: -8px;
        border: 2px solid #fff;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spinner 0.6s linear infinite;
    }
    
    @@keyframes spinner {
        to { transform: rotate(360deg); }
    }
    
    /* Fade in animation */
    @@keyframes fadeIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .alert {
        animation: fadeIn 0.5s ease;
    }
</style>

@section Scripts {
    <script>
        // Add loading state to form buttons
        document.querySelectorAll('form').forEach(form => {
            form.addEventListener('submit', function(e) {
                const btn = form.querySelector('button[type="submit"]');
                if (btn && !btn.classList.contains('loading')) {
                    btn.classList.add('loading');
                    btn.disabled = true;
                }
            });
        });
        
        // Auto-dismiss only success/warning alerts after 5 seconds (not AI recommendations)
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert:not(.alert-info)');
            alerts.forEach(alert => {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            });
        }, 5000);
        
        // Smooth scroll to search results
        const searchForm = document.querySelector('form[asp-page-handler="SearchFood"]');
        if (searchForm) {
            searchForm.addEventListener('submit', function() {
                setTimeout(() => {
                    const results = document.querySelector('.list-group');
                    if (results) {
                        results.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    }
                }, 100);
            });
        }
    </script>
}
